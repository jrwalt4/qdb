!function(e){function t(t){"use strict";function n(e,t){t?console.error("QueueDB:",e):console.info("QueueDB:",e)}function r(e,t,r){switch(typeof e){case"function":e(t,r);break;case"array":e.push(r);break;case"undefined":break;default:n(e,!0)}}function o(e){if(h.has(e))return h.get(e);var t=new i;return t.name=e,h.set(e,t),t}function s(e){var t=f.defer();return e.onerror=function(e){t.reject(e.target.error)},e.onsuccess=function(e){t.resolve(e.target.result)},t.promise}function i(e){this.name=e,this.version=0,this._isOpen=!1,this._isCurrent=!1,this._schema=null,this._db=null}function a(e,t){this._qDB=e,this._name=t}function u(e,t){this._request=e,this._filter=t||function(){return!0},this._isAlive=!1}var c=c||e.indexedDB||e.webkitIndexedDB,f=t("q")||e.Promise,d=e.qidb={},h=e.Map?new Map:{set:function(e,t){this[e]=t},get:function(e){return this[e]},has:function(e){return this.hasOwnProperty(e)}},l={collections:[{name:"data",keyPath:"_id",autoIncrement:!0}]};return d.setSchema=function(e,t){var n=o(e);return n.setSchema(t),this},d.connect=function(e,t){var s=o(e);if(s.isOpen())return n("Database "+e+" already open, close it when finished.",!1),r(t,!1,s),this;var i=f.defer(),a=c.open(e);return a.onupgradeneeded=function(e){s.setDatabase(e.target.result),s.upgrade(e.target.transaction)},a.onsuccess=function(t){var n=t.target.result;if(s.setDatabase(n),s.checkVersion())i.resolve(s);else{console.log("Need to close and reupgrade"),n.close();var r=c.open(e,n.version+1);r.onupgradeneeded=a.onupgradeneeded,r.onerror=a.onerror,r.onblocked=a.onblocked,r.onsuccess=function(e){var t=e.target.result;s.setDatabase(t),i.resolve(s)}}},a.onerror=function(e){i.reject(e.target.error)},a.onblocked=function(e){i.reject(e.target)},i.promise.then(function(e){r(t,!1,e)},function(e){r(t,e)}),this},d.drop=function(e,t){var n=new f(function(t,n){var r=c.deleteDatabase(e);r.onsuccess=t,r.onerror=n,r.onblocked=n}).then(function(e){r(t,!1,e)});return n},d.get=o,d.dbList=h,i.prototype={isOpen:function(){return!!this._db&&this._isOpen},isCurrent:function(){return this._isCurrent},setSchema:function(e){this.isOpen()?n("Database: "+this._db.name+" is already open, cannot set schema",!0):(this._schema=e,this._isCurrent=!1)},setDatabase:function(e){if(!IDBDatabase.prototype.isPrototypeOf(e))throw Error("queueDB.database must be an instance of IDBDatabase");this._db=e,this._isOpen=!0,this.name=e.name,this.version=e.version},getDatabase:function(){return this._db},checkVersion:function(){var e=this;return this._isCurrent=this._schema.collections.every(function(t){if(!e._db.objectStoreNames.contains(t.name))return!1;var n=e._db.transaction(t.name).objectStore(t.name).indexNames;return t.indices.every(function(e){return n.contains(e.name)})}),this._isCurrent},upgrade:function(e){var t=this;this._schema||(console.log("Using default schema"),this._schema=l),this._schema.collections.forEach(function(n){if(t._db.objectStoreNames.contains(n.name)){var r=e.objectStore(n.name);n.indices.forEach(function(e){r.indexNames.contains(e.name)||r.createIndex(e.name,e.keyPath,{unique:e.unique})})}else{var r=t._db.createObjectStore(n.name,{keyPath:n.keyPath,autoIncrement:n.autoIncrement});n.indices.forEach(function(e){r.createIndex(e.name,e.keyPath,{unique:e.unique})})}}),this._isCurrent=!0},collection:function(e){var t=this;return{find:function(n){var r=t._db.transaction(e,"readonly").objectStore(e);if("string"==typeof n){if(r.indexNames.contains(n))return new u(r.index(n).openCursor());var o=IDBKeyRange.bound(n,n);return new u(r.openCursor(o))}return new u(r.openCursor())},insert:function(n){var r=t._db.transaction(e,"readwrite").objectStore(e);return s(r.add(n))},update:function(n){var r=t._db.transaction(e,"readwrite").objectStore(e);return s(r.put(n))}}},close:function(){if(this._db&&this._db.close){var e=this,t=f.defer(),r=e._db.close();return r.onsuccess=function(e){t.resolve()},r.onerror=function(e){t.reject(e.target.error)},r.onblocked=function(e){t.reject(e.target.error)},t.promise.then(function(t){e._isOpen=!1},function(t){t.type.includes("block")?n("Database "+e.name+" is still in use.",!0):n(t.target.error,!0)}),t.promise}},drop:function(){var e=this;e._isClosed=!0,e._db=null}},a.prototype={_parseQuery:function(e){if(!e)return"*";var t=Object.keys(e)[0];switch(t){case"$eq":break;case"$gt":break;case"$gte":break;case"$lt":break;case"$lte":break;case"$and":}},find:function(e){var t=(this._parseQuery(e),this._qDB.getDatabase().transaction(this._name).objectStore(this._name));if("string"==typeof e){if(this._store.indexNames.contains(e))return new u(t.index(e).getCursor());var n=IDBKeyRange.bound(e,e);return new u(t.getCursor(n))}return new u(t.getCursor())},insert:function(e){var t=f.defer(),n=this._store.add(e);return n.onsuccess=function(e){t.resolve(e.target.result)},n.onerror=function(e){t.reject(e.target.error)},t.promise},update:function(e){var t=f.defer(),n=this._store.put(oItem);return n.onsuccess=function(e){t.resolve(e.target.result)},n.onerror=function(e){t.reject(e.target.error)},t.promise}},u.prototype={isAlive:function(){return this._isAlive},each:function(e){var t=f.defer(),n=this,o=0;return this._request.onsuccess=function(s){if(s&&s.target.result){var i=s.target.result;o++,n._filter(i.value)&&r(e,i.value,o),i["continue"]()}else t.resolve()},this._request.onerror=function(n){r(e,n.target.error),t.reject(n.target.error)},t.promise},first:function(e){n("Cursor.first() not implemented",!0)}},d}e=e||window,"undefined"==typeof exports&&"undefined"==typeof module||(exports=module.exports=t(require)),"undefined"!=typeof define&&define.amd?define("qidb",["require"],t):t(function(t){return e[t]})}(this);